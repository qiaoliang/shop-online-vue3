# 在棕地中工作：完整指南

> **强烈推荐：使用 Gemini Web 或 Gemini CLI 生成棕地文档！**
>
> Gemini Web 的 1M+ token 上下文窗口或 Gemini CLI（当它工作时）可以一次性分析您的整个代码库或其关键部分（显然在合理范围内）：
>
> - 通过 GitHub URL 上传或在项目文件夹中使用 gemini cli
> - 如果在 Web 中：上传多达 1000 个文件或压缩的项目，或者只提供 github url

## 什么是棕地开发？

棕地开发是指为现有软件项目添加功能、修复错误或进行现代化改造。与绿地（新）项目不同，棕地工作需要理解现有代码、尊重约束并确保新更改无缝集成，而不会破坏现有功能。

## 何时将 BMad 用于棕地

- 为现有应用程序添加重要新功能
- 现代化遗留代码库
- 集成新技术或服务
- 重构复杂系统
- 修复需要架构理解的错误
- 文档化未文档化的系统

## 何时不使用棕地流程

如果您刚刚使用 BMad 完成了 MVP，并且您想继续进行 MVP 后续工作，那么更简单的方法是与 PM 沟通，让他与您合作创建一个新的史诗添加到 PRD 中，分片史诗，与架构师一起更新任何架构文档，然后从那里开始。

## 完整的棕地工作流

### 选择您的方法

#### 方法 A：PRD 优先（推荐用于添加非常大且复杂的新功能、单个或多个史诗或大规模更改）

**最适合**：大型代码库、单体仓库，或者当您确切知道要构建什么时

1. **首先创建 PRD** 以定义需求
2. **仅根据 PRD 需求文档相关区域**
3. **更高效** - 避免文档化未使用的代码

#### 方法 B：文档优先（适用于较小项目）

**最适合**：较小代码库、未知系统或探索性更改

1. **首先文档化整个系统**
2. **创建 PRD** 并提供完整上下文
3. **更彻底** - 捕获所有内容

### 方法 A：PRD 优先工作流（推荐）

#### 阶段 1：首先定义需求

**在 Gemini Web 中（已上传您的代码库）：**

```bash
@pm
*create-doc brownfield-prd
```

PM 将：

- **询问您的增强功能**需求
- **探索代码库**以了解当前状态
- **识别受影响的区域**，需要文档化
- **创建重点 PRD**，范围清晰

**关键优势**：PRD 识别出您的单体仓库/大型代码库中实际需要文档化的部分！

#### 阶段 2：重点文档化

**仍在 Gemini Web 中，现在具有 PRD 上下文：**

```bash
@analyst
*document-project
```

分析师将：

- 如果未提供 PRD，则**询问您的重点**
- **提供选项**：创建 PRD、提供需求或描述增强功能
- **参考 PRD/描述**以了解范围
- **重点关注** PRD 或您的描述中识别出的**相关模块**
- **跳过不相关的区域**以保持文档精简
- **生成一个架构文档**，适用于所有环境

分析师创建：

- **一个全面的架构文档**，遵循 fullstack-architecture 模板
- **涵盖所有系统方面**，在一个文件中
- **易于复制和保存**为 `docs/project-architecture.md`
- 如果需要，以后可以在 IDE 中分片

例如，如果您说“向用户服务添加支付处理”：

- 仅文档化：用户服务、API 端点、数据库模式、支付集成
- 创建仅显示支付相关代码路径的重点源树
- 跳过：管理面板、报告模块、不相关的微服务

### 方法 B：文档优先工作流

#### 阶段 1：文档化现有系统

**最佳方法 - 具有 1M+ 上下文的 Gemini Web**：

1. **转到 Gemini Web** (gemini.google.com)
2. **上传您的项目**：
   - **选项 A**：直接粘贴您的 GitHub 仓库 URL
   - **选项 B**：从您的 src/project 文件夹上传多达 1000 个文件
   - **选项 C**：压缩您的项目并上传存档
3. **加载分析师代理**：上传 `dist/agents/analyst.txt`
4. **运行文档**：输入 `*document-project`

分析师将生成所有内容的全面文档。

#### 阶段 2：规划您的增强功能

#### 选项 A：完整棕地工作流（推荐用于重大更改）

**1. 创建棕地 PRD**：

```bash
@pm
*create-doc brownfield-prd
```

PM 代理将：

- **分析**阶段 1 中的**现有文档**
- **向您请求具体的增强功能详细信息**
- **评估复杂性**并推荐方法
- **为增强功能创建史诗/故事结构**
- **识别风险和集成点**

**PM 代理如何获取项目上下文**：

- 在 Gemini Web 中：已从阶段 1 文档中获得完整的项目上下文
- 在 IDE 中：将询问“请提供您现有项目文档的路径”

**您将遇到的关键提示**：

- “您想添加什么具体的增强功能或特性？”
- “是否有任何现有系统或 API 需要集成？”
- “我们必须遵守哪些关键约束？”
- “您的时间表和团队规模是多少？”

**2. 创建棕地架构**：

```bash
@architect
*create-doc brownfield-architecture
```

架构师将：

- **审查棕地 PRD**
- **设计集成策略**
- 如果需要，**规划迁移方法**
- **识别技术风险**
- **定义兼容性要求**

#### 选项 B：快速增强（针对重点更改）

**对于没有完整 PRD 的单个史诗**：

```bash
@pm
*brownfield-create-epic
```

使用时：

- 增强功能定义明确且独立
- 现有文档全面
- 更改不影响多个系统
- 您需要快速周转

**对于单个故事**：

```bash
@pm
*brownfield-create-story
```

使用时：

- 错误修复或微小功能
- 非常独立的更改
- 无架构影响
- 清晰的实施路径

### 阶段 3：验证规划工件

```bash
@po
*execute-checklist po-master-checklist
```

PO 确保：

- 与现有系统的兼容性
- 没有计划破坏性更改
- 风险缓解策略到位
- 清晰的集成方法

### 阶段 4：过渡到开发

遵循增强的 IDE 开发工作流：

1. **确保文档在项目中**：

   - 复制 `docs/prd.md`（或 brownfield-prd.md）
   - 复制 `docs/architecture.md`（或 brownfield-architecture.md）

2. **分片文档**：

   ```bash
   @po
   # 要求分片 docs/prd.md
   ```

3. **开发周期**：
   - **SM** 创建具有集成意识的故事
   - **开发人员** 在尊重现有代码的情况下实施
   - **QA** 审查兼容性和改进

## 棕地最佳实践

### 1. 始终先文档化

即使您认为您了解代码库：

- 运行 `document-project` 以捕获当前状态
- AI 代理需要此上下文
- 发现未文档化的模式

### 2. 尊重现有模式

棕地模板专门寻找：

- 当前编码约定
- 现有架构模式
- 技术约束
- 团队偏好

### 3. 规划逐步推出

棕地更改应：

- 支持功能标志
- 规划回滚策略
- 包含迁移脚本
- 保持向后兼容性

### 4. 彻底测试集成

重点测试：

- 集成点
- 现有功能（回归）
- 性能影响
- 数据迁移

### 5. 沟通更改

文档：

- 更改了什么以及为什么
- 迁移说明
- 引入的新模式
- 弃用通知

## 常见棕地场景

### 场景 1：添加新功能

1. 文档化现有系统
2. 创建专注于集成的棕地 PRD
3. 架构强调兼容性
4. 故事包含集成任务

### 场景 2：现代化遗留代码

1. 广泛的文档阶段
2. PRD 包含迁移策略
3. 架构规划逐步过渡
4. 故事遵循绞杀者模式

### 场景 3：复杂系统中的错误修复

1. 文档化相关子系统
2. 使用 `brownfield-create-story` 进行重点修复
3. 包含回归测试要求
4. QA 验证无副作用

### 场景 4：API 集成

1. 文档化现有 API 模式
2. PRD 定义集成要求
3. 架构确保一致模式
4. 故事包含 API 文档更新

## 故障排除

### “AI 不理解我的代码库”

**解决方案**：使用更具体的关键文件路径重新运行 `document-project`

### “生成的计划不符合我们的模式”

**解决方案**：在规划阶段之前，使用您的特定约定更新生成的文档

### “小改动有太多样板文件”

**解决方案**：使用 `brownfield-create-story` 而不是完整工作流

### “集成点不明确”

**解决方案**：在创建 PRD 期间提供更多上下文，特别是突出显示集成系统

## 快速参考

### 棕地特定命令

```bash
# 文档化现有项目
@analyst → *document-project

# 创建增强 PRD
@pm → *create-doc brownfield-prd

# 创建具有集成重点的架构
@architect → *create-doc brownfield-architecture

# 快速创建史诗
@pm → *brownfield-create-epic

# 单个故事创建
@pm → *brownfield-create-story
```

### 决策树

```text
您有大型代码库或单体仓库吗？
├─ 是 → PRD 优先方法
│   └─ 创建 PRD → 仅文档化受影响的区域
└─ 否 → 代码库对您来说熟悉吗？
    ├─ 是 → PRD 优先方法
    └─ 否 → 文档优先方法

这是影响多个系统的重大增强功能吗？
├─ 是 → 完整棕地工作流
└─ 否 → 这不仅仅是简单的错误修复吗？
    ├─ 是 → brownfield-create-epic
    └─ 否 → brownfield-create-story
```

## 结论

使用 BMad-Method 进行棕地开发在修改现有系统时提供了结构和安全性。关键在于通过文档提供全面的上下文，使用考虑集成需求的专业模板，以及遵循尊重现有约束同时促进进展的工作流。

记住：**先文档化，仔细规划，安全集成**
