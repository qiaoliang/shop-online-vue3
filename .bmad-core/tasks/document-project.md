# 文档现有项目

## 目的

为现有项目生成全面的文档，并针对 AI 开发代理进行优化。此任务创建结构化的参考材料，使 AI 代理能够理解项目上下文、约定和模式，从而有效地为任何代码库做出贡献。

## 任务说明

### 1. 初始项目分析

**关键：** 首先，检查上下文中是否存在 PRD 或需求文档。如果存在，则仅使用它将文档工作重点放在相关区域。

**如果存在 PRD**：

- 审查 PRD 以了解计划中的增强/功能
- 识别将受影响的模块、服务或区域
- 仅将文档重点放在这些相关区域
- 跳过代码库中不相关的部分以保持文档精简

**如果不存在 PRD**：
询问用户：

“我注意到您没有提供 PRD 或需求文档。为了创建更专注和有用的文档，我建议以下选项之一：

1. **首先创建 PRD** - 您希望我在文档编制之前帮助创建棕地 PRD 吗？这有助于将文档重点放在相关区域。

2. **提供现有需求** - 您是否有可以共享的需求文档、史诗或功能描述？

3. **描述重点** - 您能否简要描述您计划的增强或功能？例如：
   - '向用户服务添加支付处理'
   - '重构身份验证模块'
   - '与新的第三方 API 集成'

4. **文档所有内容** - 或者我应该继续对整个代码库进行全面文档编制吗？（注意：这可能会为大型项目创建过多的文档）

请告诉我您的偏好，或者如果您愿意，我可以继续进行完整文档编制。”

根据他们的回答：

- 如果他们选择选项 1-3：使用该上下文来重点文档编制
- 如果他们选择选项 4 或拒绝：继续下面的全面分析

首先对现有项目进行分析。使用可用工具：

1. **项目结构发现**：检查根目录结构，识别主要文件夹，并了解整体组织
2. **技术栈识别**：查找 package.json、requirements.txt、Cargo.toml、pom.xml 等，以识别语言、框架和依赖项
3. **构建系统分析**：查找构建脚本、CI/CD 配置和开发命令
4. **现有文档审查**：检查 README 文件、docs 文件夹和任何现有文档
5. **代码模式分析**：抽样关键文件以了解编码模式、命名约定和架构方法

向用户提出这些启发性问题，以更好地了解他们的需求：

- 此项目的主要目的是什么？
- 代码库中是否有任何特别复杂或对代理理解很重要的特定区域？
- 您希望 AI 代理在此项目上执行哪些类型的任务？（例如，错误修复、功能添加、重构、测试）
- 您是否有任何现有的文档标准或偏好格式？
- 文档应针对哪个技术细节级别？（初级开发人员、高级开发人员、混合团队）
- 您是否正在计划特定的功能或增强？（这有助于重点文档编制）

### 2. 深度代码库分析

关键：在生成文档之前，对现有代码库进行广泛分析：

1. **探索关键领域**：
   - 入口点（主文件、索引文件、应用程序初始化程序）
   - 配置文件和环境设置
   - 包依赖项和版本
   - 构建和部署配置
   - 测试套件和覆盖率

2. **提出澄清问题**：
   - “我看到您正在使用 [技术 X]。我应该记录任何自定义模式或约定吗？”
   - “这个系统最关键/最复杂的部分是什么，开发人员在哪些方面遇到困难？”
   - “我应该捕获任何未记录的‘部落知识’领域吗？”
   - “我应该记录哪些技术债务或已知问题？”
   - “代码库的哪些部分更改最频繁？”

3. **映射现实**：
   - 识别使用的实际模式（而不是理论上的最佳实践）
   - 查找关键业务逻辑所在的位置
   - 定位集成点和外部依赖项
   - 记录变通方法和技术债务
   - 注意与标准模式不同的区域

**如果提供了 PRD**：还要分析增强功能需要更改什么

### 3. 核心文档生成

[[LLM: 生成一份全面的棕地架构文档，反映代码库的实际状态。

**关键**：这不是一份理想的架构文档。记录现有内容，包括：

- 技术债务和变通方法
- 不同部分之间不一致的模式
- 无法更改的遗留代码
- 集成约束
- 性能瓶颈

**文档结构**：

# [项目名称] 棕地架构文档

## 简介

本文档捕获了 [项目名称] 代码库的当前状态，包括技术债务、变通方法和实际模式。它可作为 AI 代理进行增强工作的参考。

### 文档范围

[如果提供了 PRD：“重点关注与 {增强描述} 相关的领域”]
[如果未提供 PRD：“整个系统的全面文档”]

### 变更日志

| 日期 | 版本 | 描述 | 作者 |
|------|---------|-------------|--------|
| [日期] | 1.0 | 初始棕地分析 | [分析师] |

## 快速参考 - 关键文件和入口点

### 理解系统的关键文件

- **主要入口**：`src/index.js`（或实际入口点）
- **配置**：`config/app.config.js`、`.env.example`
- **核心业务逻辑**：`src/services/`、`src/domain/`
- **API 定义**：`src/routes/` 或 OpenAPI 规范链接
- **数据库模型**：`src/models/` 或模式文件链接
- **关键算法**：[列出具有复杂逻辑的特定文件]

### 如果提供了 PRD - 增强影响区域

[突出显示计划增强功能将影响哪些文件/模块]

## 高级架构

### 技术摘要

### 实际技术栈（来自 package.json/requirements.txt）

| 类别 | 技术 | 版本 | 备注 |
|----------|------------|---------|--------|
| 运行时 | Node.js | 16.x | [任何约束] |
| 框架 | Express | 4.18.2 | [自定义中间件？] |
| 数据库 | PostgreSQL | 13 | [连接池设置] |

等等...

### 仓库结构现实检查

- 类型：[Monorepo/Polyrepo/Hybrid]
- 包管理器：[npm/yarn/pnpm]
- 值得注意：[任何不寻常的结构决策]

## 源树和模块组织

### 项目结构（实际）

```text
project-root/
├── src/
│   ├── controllers/     # HTTP 请求处理程序
│   ├── services/        # 业务逻辑（注意：用户和支付服务之间存在不一致的模式）
│   ├── models/          # 数据库模型 (Sequelize)
│   ├── utils/           # 混合包 - 需要重构
│   └── legacy/          # 请勿修改 - 旧支付系统仍在使用
├── tests/               # Jest 测试（60% 覆盖率）
├── scripts/             # 构建和部署脚本
└── config/              # 环境配置
```

### 关键模块及其用途

- **用户管理**：`src/services/userService.js` - 处理所有用户操作
- **身份验证**：`src/middleware/auth.js` - 基于 JWT，自定义实现
- **支付处理**：`src/legacy/payment.js` - 关键：请勿重构，紧密耦合
- **[列出其他关键模块及其实际文件]**

## 数据模型和 API

### 数据模型

无需重复，引用实际模型文件：
- **用户模型**：请参阅 `src/models/User.js`
- **订单模型**：请参阅 `src/models/Order.js`
- **相关类型**：`src/types/` 中的 TypeScript 定义

### API 规范

- **OpenAPI 规范**：`docs/api/openapi.yaml`（如果存在）
- **Postman 集合**：`docs/api/postman-collection.json`
- **手动端点**：[列出发现的任何未记录的端点]

## 技术债务和已知问题

### 关键技术债务

1. **支付服务**：`src/legacy/payment.js` 中的遗留代码 - 紧密耦合，无测试
2. **用户服务**：与其他服务模式不同，使用回调而不是 Promise
3. **数据库迁移**：手动跟踪，无适当的迁移工具
4. **[其他重大债务]**

### 变通方法和注意事项

- **环境变量**：即使是暂存环境也必须设置 `NODE_ENV=production`（历史原因）
- **数据库连接**：连接池硬编码为 10，更改会破坏支付服务
- **[开发人员需要了解的其他变通方法]**

## 集成点和外部依赖

### 外部服务

| 服务 | 目的 | 集成类型 | 关键文件 |
|---------|---------|------------------|-----------|
| Stripe | 支付 | REST API | `src/integrations/stripe/` |
| SendGrid | 电子邮件 | SDK | `src/services/emailService.js` |

等等...

### 内部集成点

- **前端通信**：端口 3000 上的 REST API，需要特定标头
- **后台作业**：Redis 队列，请参阅 `src/workers/`
- **[其他集成]**

## 开发和部署

### 本地开发设置

1. 实际可行的步骤（非理想步骤）
2. 已知设置问题
3. 所需环境变量（请参阅 `.env.example`）

### 构建和部署过程

- **构建命令**：`npm run build`（`webpack.config.js` 中的 webpack 配置）
- **部署**：通过 `scripts/deploy.sh` 手动部署
- **环境**：开发、暂存、生产（请参阅 `config/environments/`）

## 测试现实

### 当前测试覆盖率

- 单元测试：60% 覆盖率 (Jest)
- 集成测试：最少，在 `tests/integration/` 中
- E2E 测试：无
- 手动测试：主要 QA 方法

### 运行测试

```bash
npm test           # 运行单元测试
npm run test:integration  # 运行集成测试（需要本地数据库）
```

## 如果提供了增强 PRD - 影响分析

### 需要修改的文件

根据增强需求，这些文件将受到影响：
- `src/services/userService.js` - 添加新的用户字段
- `src/models/User.js` - 更新模式
- `src/routes/userRoutes.js` - 新端点
- [等等...]

### 需要的新文件/模块

- `src/services/newFeatureService.js` - 新业务逻辑
- `src/models/NewFeature.js` - 新数据模型
- [等等...]

### 集成考虑

- 需要与现有身份验证中间件集成
- 必须遵循 `src/utils/responseFormatter.js` 中现有的响应格式
- [其他集成点]

## 附录 - 有用的命令和脚本

### 常用命令

```bash
npm run dev         # 启动开发服务器
npm run build       # 生产构建
npm run migrate     # 运行数据库迁移
npm run seed        # 种子测试数据
```

### 调试和故障排除

- **日志**：检查 `logs/app.log` 获取应用程序日志
- **调试模式**：设置 `DEBUG=app:*` 以获取详细日志记录
- **常见问题**：请参阅 `docs/troubleshooting.md`]]

### 4. 文档交付

1. **在 Web UI 中（Gemini、ChatGPT、Claude）**：
   - 在一个响应中呈现整个文档（如果太长则分多次）
   - 告诉用户复制并保存为 `docs/brownfield-architecture.md` 或 `docs/project-architecture.md`
   - 提及如果需要，以后可以在 IDE 中分片

2. **在 IDE 环境中**：
   - 将文档创建为 `docs/brownfield-architecture.md`
   - 通知用户此单个文档包含所有架构信息
   - 如果需要，以后可以使用 PO 代理进行分片

文档应足够全面，以便未来的代理能够理解：

- 系统的实际状态（非理想化）
- 关键文件和逻辑的查找位置
- 存在哪些技术债务
- 必须遵守哪些约束
- 如果提供了 PRD：清晰的影响分析，显示需要更改什么

### 5. 质量保证

关键：在最终确定文档之前：

1. **准确性检查**：验证所有技术细节与实际代码库匹配
2. **完整性审查**：确保所有主要系统组件都已文档化
3. **焦点验证**：如果用户提供了范围，则验证相关区域是否得到强调
4. **清晰度评估**：检查解释是否对 AI 代理清晰
5. **导航**：确保文档具有清晰的章节结构，以便于参考

在主要章节之后应用高级启发任务，以根据用户反馈进行完善。

## 成功标准

- 创建了单个全面的棕地架构文档
- 文档反映了实际情况，包括技术债务和变通方法
- 关键文件和模块通过实际路径引用
- 模型/API 引用源文件而不是重复内容
- 如果提供了 PRD：清晰的影响分析，显示需要更改什么
- 文档使 AI 代理能够导航和理解实际代码库
- 技术约束和“陷阱”已清晰记录

## 注意事项

- 此任务创建一个捕获系统真实状态的文档
- 尽可能引用实际文件而不是重复内容
- 诚实地记录技术债务、变通方法和约束
- 对于带有 PRD 的棕地项目：提供清晰的增强影响分析
- 目标是为 AI 代理进行实际工作提供实用的文档
