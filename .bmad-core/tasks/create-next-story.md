# 创建下一个故事任务

## 目的

根据项目进度和史诗定义，识别下一个逻辑故事，然后使用 `故事模板` 准备一个全面、自包含且可操作的故事文件。此任务确保故事富含所有必要的技术上下文、需求和验收标准，使其能够由开发代理高效实施，而无需额外研究或寻找其自身上下文。

## 顺序任务执行（当前任务未完成前请勿继续）

### 0. 加载核心配置并检查工作流

- 从项目根目录加载 `.bmad-core/core-config.yaml`
- 如果文件不存在，则暂停并通知用户：“未找到 core-config.yaml。故事创建需要此文件。您可以选择：1) 从 GITHUB bmad-core/core-config.yaml 复制并为您的项目配置，或者 2) 对您的项目运行 BMad 安装程序以自动升级和添加文件。请在继续之前添加并配置 core-config.yaml。”
- 提取关键配置：`devStoryLocation`、`prd.*`、`architecture.*`、`workflow.*`

### 1. 识别要准备的下一个故事

#### 1.1 定位史诗文件并审查现有故事

- 根据配置中的 `prdSharded`，定位史诗文件（分片位置/模式或单体 PRD 部分）
- 如果 `devStoryLocation` 有故事文件，则加载最高的 `{epicNum}.{storyNum}.story.md` 文件
- **如果最高故事存在：**
  - 验证状态是否为“完成”。如果不是，则提醒用户：“警报：发现未完成的故事！文件：{lastEpicNum}.{lastStoryNum}.story.md 状态：[当前状态] 您应该首先修复此故事，但您是否愿意承担风险并覆盖以草稿形式创建下一个故事？”
  - 如果继续，则选择当前史诗中的下一个顺序故事
  - 如果史诗已完成，则提示用户：“史诗 {epicNum} 完成：史诗 {epicNum} 中的所有故事都已完成。您是否愿意：1) 从故事 1 开始史诗 {epicNum + 1} 2) 选择一个特定故事进行工作 3) 取消故事创建”
  - **关键**：绝不自动跳到另一个史诗。用户必须明确指示要创建哪个故事。
- **如果不存在故事文件：** 下一个故事始终是 1.1（第一个史诗的第一个故事）
- 向用户宣布已识别的故事：“已识别要准备的下一个故事：{epicNum}.{storyNum} - {故事标题}”

### 2. 收集故事需求和先前故事上下文

- 从已识别的史诗文件中提取故事需求
- 如果存在先前故事，则审查开发代理记录部分，以了解：
  - 完成备注和调试日志引用
  - 实施偏差和技术决策
  - 遇到的挑战和经验教训
- 提取相关见解，为当前故事的准备提供信息

### 3. 收集架构上下文

#### 3.1 确定架构阅读策略

- **如果 `architectureVersion: >= v4` 且 `architectureSharded: true`**：读取 `{architectureShardedLocation}/index.md`，然后遵循下面的结构化阅读顺序
- **否则**：使用单体 `architectureFile` 获取类似部分

#### 3.2 根据故事类型阅读架构文档

**对于所有故事：** tech-stack.md、unified-project-structure.md、coding-standards.md、testing-strategy.md

**对于后端/API 故事，此外：** data-models.md、database-schema.md、backend-architecture.md、rest-api-spec.md、external-apis.md

**对于前端/UI 故事，此外：** frontend-architecture.md、components.md、core-workflows.md、data-models.md

**对于全栈故事：** 阅读上述后端和前端部分

#### 3.3 提取故事特定的技术细节

仅提取与实施当前故事直接相关的信息。不要发明源文档中没有的新库、模式或标准。

提取：

- 故事将使用的特定数据模型、模式或结构
- 故事必须实施或消费的 API 端点
- 故事中 UI 元素的组件规范
- 新代码的文件路径和命名约定
- 故事功能特定的测试要求
- 影响故事的安全或性能考虑因素

始终引用源文档：`[Source: architecture/{filename}.md#{section}]`

### 4. 验证项目结构对齐

- 将故事需求与 `docs/architecture/unified-project-structure.md` 中的项目结构指南进行交叉引用
- 确保文件路径、组件位置或模块名称与定义的结构对齐
- 在故事草稿中的“项目结构说明”部分记录任何结构冲突

### 5. 使用完整上下文填充故事模板

- 使用故事模板创建新的故事文件：`{devStoryLocation}/{epicNum}.{storyNum}.story.md`
- 填写基本故事信息：标题、状态（草稿）、故事陈述、史诗中的验收标准
- **`开发说明` 部分（关键）：**
  - 关键：此部分必须仅包含从架构文档中提取的信息。绝不发明或假设技术细节。
  - 包含步骤 2-3 中的所有相关技术细节，按类别组织：
    - **先前故事见解**：先前故事的关键经验教训
    - **数据模型**：特定模式、验证规则、关系 [附源引用]
    - **API 规范**：端点详细信息、请求/响应格式、身份验证要求 [附源引用]
    - **组件规范**：UI 组件详细信息、属性、状态管理 [附源引用]
    - **文件位置**：根据项目结构应创建新代码的确切路径
    - **测试要求**：来自 testing-strategy.md 的特定测试用例或策略
    - **技术约束**：版本要求、性能考虑因素、安全规则
  - 每个技术细节都必须包含其源引用：`[Source: architecture/{filename}.md#{section}]`
  - 如果在架构文档中未找到某个类别的信息，则明确说明：“在架构文档中未找到特定指导”
- **`任务/子任务` 部分：**
  - 仅根据：史诗需求、故事 AC、审查的架构信息生成详细的、顺序的技术任务列表
  - 每个任务都必须引用相关的架构文档
  - 根据测试策略将单元测试作为明确的子任务包含在内
  - 在适用时将任务链接到 AC（例如，`任务 1 (AC: 1, 3)`）
- 添加有关步骤 4 中发现的项目结构对齐或差异的说明

### 6. 故事草稿完成和审查

- 审查所有部分的完整性和准确性
- 验证所有源引用都包含在技术细节中
- 确保任务与史诗需求和架构约束都对齐
- 将状态更新为“草稿”并保存故事文件
- 执行 `.bmad-core/tasks/execute-checklist` `.bmad-core/checklists/story-draft-checklist`
- 向用户提供摘要，包括：
  - 创建的故事：`{devStoryLocation}/{epicNum}.{storyNum}.story.md`
  - 状态：草稿
  - 包含在架构文档中的关键技术组件
  - 史诗和架构之间注意到的任何偏差或冲突
  - 清单结果
  - 后续步骤：对于复杂故事，建议用户仔细审查故事草稿，并可选择让 PO 运行任务 `.bmad-core/tasks/validate-next-story`
