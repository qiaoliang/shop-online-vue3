# 创建旧项目故事任务

## 目的

为旧项目（brownfield projects）创建详细、可随时实施的故事，这些项目可能没有传统的、分片式的PRD/架构文档。此任务旨在弥合各种文档格式（如 `document-project` 的输出、旧项目PRD、史诗任务或用户文档）与可供开发代理（Dev agent）执行的故事之间的差距。

## 何时使用此任务

**在以下情况使用此任务：**

- 处理文档不标准的旧项目
- 需要从 `document-project` 的输出创建故事
- 在没有完整PRD/架构的情况下，从旧项目的史诗任务开始工作
- 现有项目文档不遵循 BMad v4+ 结构
- 在创建故事期间需要从用户那里收集额外信息

**在以下情况使用 `create-next-story`：**

- 使用已正确分片的PRD和v4架构文档
- 遵循标准的新项目（greenfield）或文档完善的旧项目工作流
- 所有技术背景信息都以结构化格式提供

## 任务执行说明

### 0. 文档背景

按以下顺序检查可用的文档：

1.  **分片式PRD/架构** (`docs/prd/`, `docs/architecture/`)
    -   如果找到，建议改用 `create-next-story` 任务

2.  **旧项目架构文档** (`docs/brownfield-architecture.md` 或类似文件)
    -   由 `document-project` 任务创建
    -   包含实际系统状态、技术债务、临时解决方案

3.  **旧项目PRD** (`docs/prd.md`)
    -   可能包含嵌入的技术细节

4.  **史诗任务文件** (`docs/epics/` 或类似文件夹)
    -   由 `brownfield-create-epic` 任务创建

5.  **用户提供的文档**
    -   要求用户指定位置和格式

### 1. 故事识别与背景信息收集

#### 1.1 识别故事来源

根据可用文档：

-   **来自旧项目PRD**：从史诗任务部分提取故事
-   **来自史诗任务文件**：阅读史诗任务定义和故事列表
-   **根据用户指示**：询问用户要实施哪个具体增强功能
-   **无明确来源**：与用户合作定义故事范围

#### 1.2 收集必要背景信息

重要提示：对于旧项目的故事，您必须收集足够的背景信息以确保安全实施。准备好向用户询问缺失的信息。

**所需信息清单：**

-   [ ] 哪些现有功能可能会受到影响？
-   [ ] 与当前代码的集成点是什么？
-   [ ] 应遵循哪些模式（并提供示例）？
-   [ ] 存在哪些技术限制？
-   [ ] 是否有任何需要注意的“陷阱”或临时解决方案？

如果缺少任何所需信息，请列出缺失的信息并要求用户提供。

### 2. 从可用来源中提取技术背景

#### 2.1 从 `document-project` 输出中提取

如果使用 `document-project` 生成的 `brownfield-architecture.md`：

-   **技术债务部分**：注意影响此故事的任何临时解决方案
-   **关键文件部分**：识别需要修改的文件
-   **集成点**：查找现有的集成模式
-   **已知问题**：检查故事是否涉及有问题的区域
-   **实际技术栈**：验证版本和限制

#### 2.2 从旧项目PRD中提取

如果使用旧项目PRD：

-   **技术限制部分**：提取所有相关限制
-   **集成要求**：注意兼容性要求
-   **代码组织**：遵循指定的模式
-   **风险评估**：了解潜在影响

#### 2.3 从用户文档中提取

要求用户帮助识别：

-   相关的技术规范
-   可供遵循的现有代码示例
-   集成要求
-   项目中使用的测试方法

### 3. 通过逐步收集细节来创建故事

#### 3.1 创建初始故事结构

从故事模板开始，填入已知信息：

```markdown
# 故事 {{Enhancement Title}}

## 状态: 草稿

## 故事

作为一名 {{user_type}},
我想要 {{enhancement_capability}},
以便于 {{value_delivered}}.

## 背景来源

-   源文档: {{document name/type}}
-   增强类型: {{single feature/bug fix/integration/etc}}
-   对现有系统的影响: {{brief assessment}}
```

#### 3.2 制定验收标准

重要提示：对于旧项目，务必包含关于维护现有功能的标准。

标准结构：

1.  新功能按规定工作
2.  现有的 {{affected feature}} 继续保持不变
3.  与 {{existing system}} 的集成保持当前行为
4.  在 {{related area}} 没有功能回归
5.  性能保持在可接受范围内

#### 3.3 收集技术指导

重要提示：如果信息缺失，这是您需要与用户互动的地方。

使用可用信息创建“开发技术指导”部分：

```markdown
## 开发技术指导

### 现有系统背景
[从可用文档中提取]

### 集成方法
[基于找到的模式或询问用户]

### 技术限制
[来自文档或用户输入]

### 缺失信息

重要提示：列出您找不到的、开发人员将需要的任何信息，并请求提供缺失的信息。

### 4. 带有安全检查的任务生成

#### 4.1 生成实施任务

根据收集到的背景信息，创建任务，这些任务应：

-   如果对系统的理解不完整，则包含探索性任务
-   为现有功能添加验证任务
-   包含回滚方案的考量
-   在已知时引用特定的文件/模式

旧项目的示例任务结构：

```markdown
## 任务 / 子任务

-   [ ] 任务1：分析现有的 {{component/feature}} 实现
    -   [ ] 查看 {{specific files}} 以了解当前模式
    -   [ ] 记录集成点
    -   [ ] 识别潜在影响

-   [ ] 任务2：实现 {{new functionality}}
    -   [ ] 遵循 {{example file}} 中的模式
    -   [ ] 与 {{existing component}} 集成
    -   [ ] 保持与 {{constraint}} 的兼容性

-   [ ] 任务3：验证现有功能
    -   [ ] 测试 {{existing feature 1}} 仍然有效
    -   [ ] 验证 {{integration point}} 的行为未改变
    -   [ ] 检查性能影响

-   [ ] 任务4：添加测试
    -   [ ] 遵循 {{project test pattern}} 的单元测试
    -   [ ] 针对 {{integration point}} 的集成测试
    -   [ ] 如果需要，更新现有测试
```

### 5. 风险评估与缓解

重要提示：对于旧项目 - 始终包含风险评估。

为旧项目特有的风险添加部分：

```markdown
## 风险评估

### 实施风险
-   **主要风险**: {{main risk to existing system}}
-   **缓解措施**: {{how to address}}
-   **验证方法**: {{how to confirm safety}}

### 回滚计划
-   {{如果需要，撤销更改的简单步骤}}

### 安全检查
-   [ ] 在更改前测试现有的 {{feature}}
-   [ ] 更改可以通过功能开关或隔离方式进行
-   [ ] 回滚过程已记录
```

### 6. 最终故事验证

在最终确定之前：

1.  **完整性检查**:
    -   [ ] 故事有明确的范围和验收标准
    -   [ ] 技术背景足以支持实施
    -   [ ] 集成方法已定义
    -   [ ] 风险已识别并有缓解措施

2.  **安全检查**:
    -   [ ] 已包含对现有功能的保护措施
    -   [ ] 回滚计划是可行的
    -   [ ] 测试涵盖新功能和现有功能

3.  **信息缺口**:
    -   [ ] 已从用户处收集所有关键的缺失信息
    -   [ ] 为开发代理记录了剩余的未知信息
    -   [ ] 在需要时添加了探索性任务

### 7. 故事输出格式

使用适当的命名保存故事：

-   如果来自史诗任务: `docs/stories/epic-{n}-story-{m}.md`
-   如果独立: `docs/stories/brownfield-{feature-name}.md`
-   如果按顺序: 遵循现有的故事编号

包含一个头部注释，说明文档背景：

```markdown
# 故事: {{Title}}

<!-- 来源: {{documentation type used}} -->
<!-- 背景: 对 {{existing system}} 的旧项目增强 -->

## 状态: 草稿
[故事的其余内容...]
```

### 8. 交接沟通

向用户提供清晰的交接信息：

```text
旧项目故事已创建: {{story title}}

源文档: {{what was used}}
故事位置: {{file path}}

已识别的关键集成点:
- {{integration point 1}}
- {{integration point 2}}

已注意到的风险:
- {{primary risk}}

{{If missing info}}: 
注意：一些技术细节尚不清楚。故事中包含了探索性任务，以便在实施过程中收集所需信息。

后续步骤:
1.  审查故事的准确性
2.  验证集成方法是否与您的系统一致
3.  批准故事或请求调整
4.  然后开发代理可以带着安全检查来实施
```

## 成功标准

当满足以下条件时，旧项目故事的创建即为成功：

1.  故事可以被实施，而无需开发人员搜索多个文档
2.  集成方法清晰，对现有系统是安全的
3.  所有可用的技术背景都已被提取和组织
4.  已识别并处理了缺失的信息
5.  风险已记录，并附有缓解策略
6.  故事包含对现有功能的验证
7.  回滚方法已定义

## 重要说明

-   此任务专门用于文档不标准的旧项目
-   始终将现有系统的稳定性置于新功能之上
-   如有疑问，添加探索和验证任务
-   向用户请求澄清比做出假设要好
-   每个故事对于开发代理来说都应该是自包含的
-   在可用时，包含对现有代码模式的引用